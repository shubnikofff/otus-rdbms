# Репликация в Postgres

Для демонстрации репликации был создан тестовый стэнд в Docker, состоящий из трех кластеров Postgres: [Master](./master), [Physical replica](./physical_replica), [Logical replica](./logical_replica).

Запуск кластеров описан в [docker-compose](./docker-compose.yml) файле:
```yaml
version: "3.9"
services:
  master:
    build: ./master
    restart: always
    ports:
      - "5001:5432"
    environment:
      - POSTGRES_PASSWORD=otus
    command: ["-c", "config_file=/etc/postgresql/postgresql.conf"]

  physical_replica:
    build: ./physical_replica
    restart: always
    ports:
      - "5002:5432"
    depends_on:
      - master
    links:
      - master
    environment:
      - POSTGRES_PASSWORD=otus

  logical_replica:
    build: ./logical_replica
    restart: always
    ports:
      - "5003:5432"
    depends_on:
      - master
    links:
      - master
    environment:
      - POSTGRES_PASSWORD=otus
```
## Master
Мастер запускается с кастомными файлами конфигурации [postgresql.conf](./master/postgresql.conf) и [pg_hba.conf](./master/pg_hba.conf):

### postgresql.conf
```
listen_addresses = '*'
wal_level = logical
recovery_min_apply_delay = 5min	
```

### pg_hba.conf
```
# Allow replication connections from localhost, by a user with the replication privilege.
host    replication     all             0.0.0.0/0               md5
```

Во время старта кластера запускается скрипт [init.sh](./master/init.sh), который создает базу данных для репликации и публикацию `persons_publication`:
```shell
#!/bin/bash
set -e

cp -f /var/lib/postgresql/pg_hba.conf /var/lib/postgresql/data/pg_hba.conf
psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
    create database replica;
    \c replica;
    create table persons
    (
        id   int generated by default as identity primary key,
        name varchar not null unique
    );
    insert into persons(name) values ('Tilly'), ('Dilly'), ('Willy');
    create publication persons_publication for table persons;
EOSQL

```

## Physical replica
Во время запуска кластера для физической репликации запускается скрипт [init.sh](./physical_replica/init.sh), который устанавливает репликацию:
```shell
#!/bin/bash
set -e

rm -rf /var/lib/postgresql/data/*
pg_basebackup -p 5432 -h master -R -D /var/lib/postgresql/data/ -U postgres -W -C --slot=otus

```

## Logical replica
Во время запуска кластера для логической репликации запускается скрипт [init.sh](./logical_replica/init.sh), который создает базу данных и подписку на `persons_publication`:
```shell
#!/bin/bash
set -e

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
    create database replica;
    \c replica;
    create table persons
    (
        id   int generated by default as identity primary key,
        name varchar not null unique
    );
    create subscription persons_subscription
    connection 'host=master port=5432 user=postgres password=otus dbname=replica'
    publication persons_publication;
EOSQL
```

## Результат
В результате получилось 2 реплики - физическая и логическая. В обоих случаях синхронизация работает без ошибок.

Статистика на физической реплике:
```sql
select * from pg_stat_wal_receiver;
```
| pid | status | receive\_start\_lsn | receive\_start\_tli | written\_lsn | flushed\_lsn | received\_tli | last\_msg\_send\_time | last\_msg\_receipt\_time | latest\_end\_lsn | latest\_end\_time | slot\_name | sender\_host | sender\_port | conninfo |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 35 | streaming | 0/3000000 | 1 | 0/3000588 | 0/3000588 | 1 | 2021-09-27 10:00:42.436140 +00:00 | 2021-09-27 10:00:42.436315 +00:00 | 0/3000588 | 2021-09-27 09:56:12.016202 +00:00 | otus | master | 5432 | user=postgres password=\*\*\*\*\*\*\*\* channel\_binding=prefer dbname=replication host=master port=5432 fallback\_application\_name=walreceiver sslmode=prefer sslcompression=0 ssl\_min\_protocol\_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres target\_session\_attrs=any |

Информация по подписке на логической реплике:
```sql
select * from pg_subscription;
```
| oid | subdbid | subname | subowner | subenabled | subconninfo | subslotname | subsynccommit | subpublications |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 16397 | 16384 | persons\_subscription | 10 | true | host=master port=5432 user=postgres password=otus dbname=replica | persons\_subscription | off | {persons\_publication} |
